// 以太坊节点访问地址
var serviceAddress = "https://data-seed-prebsc-1-s2.binance.org:8545/";
// 测试账户密码
var accountsPassword = "test123456";
// 交易流水
var txIndex = 0;

var addresscompress=0xBE0cb86Dc4213d4bEbd39a68880227eC1A5d1da6;
var onechancecoin=0xE2dc057eE7cc42B74Cc74b422276411dE83EB726;
var onechance=0xd33D40e0c95d2224Fb623671d8B1008641e498A8;

// 初始化web3插件
$(function() {
	 if (typeof window.ethereum !== 'undefined'|| (typeof window.web3 !== 'undefined')) {
          // 检测到Web3浏览器用户。 现在可以使用提供程序了。
          const provider = window['ethereum'] || window.web3.currentProvider;
          // 实例化web3
          web3 = new Web3(provider);
          window.web3 = web3;//挂载在window上，方便直接获取
          //ethereum.enable() 方法请求用户授权应用访问MetaMask中的用户账号信息。
          window.ethereum.enable().then((res) => {
            console.log("当前钱包地址：" + res)
          })
        }else {
          alert("请安装MetaMask钱包")
        }

	
    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
    } else {
        web3 = new Web3(new Web3.providers.HttpProvider(serviceAddress));
    }
    // 初始化账户信息
    initAccountSelect();
});

// 初始化用户列表下拉框
function initAccountSelect() {
    $.each(web3.eth.accounts, function(index, addr) {
        $('.accountsSelect').append('<option value="addr">addr</option>'.replace(/addr/g, addr));
    });
}

// 页面跳转
function changePage(divId) {
    if (onechancecoin == undefined) {
        prompt("请先部署合约");
        return;
    }
    $('#systemDiv').hide();
    $('#sponsorDiv').hide();
    $('#consumerDiv').hide();
    $('#' + divId).show();
}

// 提示信息
function prompt(msg) {
    $('#promptDiv').prepend('<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>#msg</div>'
        .replace(/#msg/, msg));
}

// 显示账户信息
function showAccount() {
    $('#accountsTbody').empty();
    $.each(web3.eth.accounts, function(index, addr) {
    $('#accountsTbody').append('<tr><td>index</td><td>addr</td><td>ether Ether</td><td>balance C</td></tr>'
        .replace(/index/, index)
        .replace(/addr/, addr)
        .replace(/ether/, web3.fromWei(web3.eth.getBalance(addr), "ether"))
        .replace(/balance/, onechancecoin.balanceOf.call(addr)));
    });
}

// 初始化合约，包括部署与通知注册、合约地址设置操作
function init() {
    $('#initDiv').hide();
    $('#systemDiv').show();
    // 嵌套回调，实现合约部署，通知注册、合约地址设置的顺序调用
    deployAddressCompress(function() {
        deployOneChanceCoin(function() {
            showAccount();
            deployOneChance(function() {
                initSponsorEvent();
                initConsumerEvent();
                initContractAddr();
            });
        });
    });
}

// 部署AddressCompress合约
function deployAddressCompress(callback) {
    console.log("部署AddressCompress合约");
    web3.personal.unlockAccount(web3.eth.accounts[0], accountsPassword);
    var addresscompressContract = web3.eth.contract([{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"uidOf","outputs":[{"name":"","type":"uint32"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint32"}],"name":"addrOf","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"topUid","outputs":[{"name":"","type":"uint32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"regist","outputs":[{"name":"uid","type":"uint32"}],"payable":false,"type":"function"}]);
    addresscompress = addresscompressContract.new(
	{
            from: web3.eth.accounts[0], 
            data: '60606040526102cc806100126000396000f360606040526000357c0100000000000000000000000000000000000000000000000000000000900480630b688f401461005d5780631d0cce4c14610094578063db139705146100db578063ff776f551461010957610058565b610002565b34610002576100786004808035906020019091905050610140565b604051808263ffffffff16815260200191505060405180910390f35b34610002576100af6004808035906020019091905050610168565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610002576100ed60048050506101a0565b604051808263ffffffff16815260200191505060405180910390f35b346100025761012460048080359060200190919050506101b6565b604051808263ffffffff16815260200191505060405180910390f35b600060005060205280600052604060002060009150909054906101000a900463ffffffff1681565b600160005060205280600052604060002060009150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900463ffffffff1681565b60006000600060005060008473ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff1614151561020957610002565b6002600081819054906101000a900463ffffffff1660010191906101000a81548163ffffffff0219169083021790559050805080600060005060008473ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548163ffffffff0219169083021790555081600160005060008363ffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b91905056', 
            gas: 4700000
	}, 
        function (err, contract){
            if (!err && contract.address) {
                console.log("AddressCompress合约部署成功");
                prompt("AddressCompress合约部署成功");
                $('.AddressCompressAddr').text(contract.address);
                if (callback != undefined) {
                    callback();
                }
            }
        });
}

// 部署OneChanceCoin合约
function deployOneChanceCoin(callback) {
    console.log("部署OneChanceCoin合约");
    web3.personal.unlockAccount(web3.eth.accounts[0], accountsPassword);
    var onechancecoinContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_oneChance","type":"address"}],"name":"initOneChance","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_consumerUid","type":"uint32"},{"name":"_value","type":"uint32"}],"name":"consume","outputs":[{"name":"success","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"addressCompress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_addr","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"sponsor","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_receiver","type":"address"},{"name":"_value","type":"uint32"}],"name":"transfer","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"oneChance","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_receiver","type":"address"},{"name":"_value","type":"uint32"},{"name":"_txIndex","type":"uint256"}],"name":"mint","outputs":[],"payable":false,"type":"function"},{"inputs":[{"name":"_name","type":"string"},{"name":"_symbol","type":"string"},{"name":"_decimals","type":"uint8"},{"name":"_addressCompress","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[],"name":"InitOneChance","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"receiver","type":"address"},{"indexed":false,"name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"receiver","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"Mint","type":"event"}]);
    onechancecoin = onechancecoinContract.new(
        'ChanceCoin',
        'C',
        0,
        addresscompress.address,
        {
            from: web3.eth.accounts[0], 
            data: '606060405260405161113b38038061113b833981016040528080518201919060200180518201919060200180519060200190919080519060200190919050505b33600260016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055508360006000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100b957805160ff19168380011785556100ea565b828001600101855582156100ea579182015b828111156100e95782518260005055916020019190600101906100cb565b5b50905061011591906100f7565b8082111561011157600081815060009055506001016100f7565b5090565b50508260016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061016657805160ff1916838001178555610197565b82800160010185558215610197579182015b82811115610196578251826000505591602001919060010190610178565b5b5090506101c291906101a4565b808211156101be57600081815060009055506001016101a4565b5090565b505081600260006101000a81548160ff0219169083021790555080600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b50505050610f218061021a6000396000f3606060405236156100ab576000357c01000000000000000000000000000000000000000000000000000000009004806303bcebea146100b057806306fdde03146100cd5780630aa83f5a1461014d578063313ce567146101895780635d1388ce146101b457806370a08231146101f257806377c93662146102235780638009748414610261578063838736661461028757806395d89b41146102c5578063ca3181e014610345576100ab565b610002565b34610002576100cb6004808035906020019091905050610374565b005b34610002576100df6004805050610476565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561013f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610002576101716004808035906020019091908035906020019091905050610517565b60405180821515815260200191505060405180910390f35b346100025761019b6004805050610614565b604051808260ff16815260200191505060405180910390f35b34610002576101c66004805050610627565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b346100025761020d600480803590602001909190505061064d565b6040518082815260200191505060405180910390f35b3461000257610235600480505061073c565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610002576102856004808035906020019091908035906020019091905050610762565b005b34610002576102996004805050610b63565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610002576102d76004805050610b89565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103375780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610002576103726004808035906020019091908035906020019091908035906020019091905050610c2a565b005b600260019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156103d057610002565b6000600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561041757610002565b80600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507ffc61118d9baf11f37d3039c67ee749387b3655da0c80a6074b0a7364d65284a860405180905060405180910390a15b5b50565b60006000508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561050f5780601f106104e45761010080835404028352916020019161050f565b820191906000526020600020905b8154815290600101906020018083116104f257829003601f168201915b505050505081565b6000600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561057557610002565b8163ffffffff16600560005060008563ffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff1610156105ba57610002565b81600560005060008563ffffffff16815260200190815260200160002060008282829054906101000a900463ffffffff160392506101000a81548163ffffffff021916908302179055506001905061060d565b5b92915050565b600260009054906101000a900460ff1681565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060056000506000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630b688f4085604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f115610002575050506040518051906020015063ffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff16905080505b919050565b600260019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630b688f4033604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150915060008263ffffffff16141561082d57610002565b8263ffffffff16600560005060008463ffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff16101561087257610002565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630b688f4085604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150905060008163ffffffff1614156109ea57600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ff776f5585604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150905080505b600560005060008263ffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff1683600560005060008463ffffffff16815260200190815260200160002060009054906101000a900463ffffffff160163ffffffff161015610a5d57610002565b82600560005060008463ffffffff16815260200190815260200160002060008282829054906101000a900463ffffffff160392506101000a81548163ffffffff0219169083021790555082600560005060008363ffffffff16815260200190815260200160002060008282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908302179055508373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef85604051808263ffffffff16815260200191505060405180910390a35b50505050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60016000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c225780601f10610bf757610100808354040283529160200191610c22565b820191906000526020600020905b815481529060010190602001808311610c0557829003601f168201915b505050505081565b6000600260019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610c8857610002565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630b688f4085604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150905060008163ffffffff161415610e0057600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663ff776f5585604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150905080505b600560005060008263ffffffff16815260200190815260200160002060009054906101000a900463ffffffff1663ffffffff1683600560005060008463ffffffff16815260200190815260200160002060009054906101000a900463ffffffff160163ffffffff161015610e7357610002565b82600560005060008363ffffffff16815260200190815260200160002060008282829054906101000a900463ffffffff160192506101000a81548163ffffffff021916908302179055508373ffffffffffffffffffffffffffffffffffffffff167f4c209b5fc8ad50758f13e2e1088ba56a560dff690a1c6fef26394f4c03821c4f8484604051808363ffffffff1681526020018281526020019250505060405180910390a25b5b5050505056', 
            gas: 4700000
        }, 
	function (err, contract){
            if (!err && contract.address) {
                console.log("OneChanceCoin合约部署成功");
                prompt("OneChanceCoin合约部署成功");
                $('.OneChanceCoinAddr').text(contract.address);
                $('.OneChanceCoinSponsorAddr').text(onechancecoin.sponsor.call());
                $('.OneChanceCoinAddressCompressAddr').text(onechancecoin.addressCompress.call());
                $('.OneChanceCoinOneChanceAddr').text(onechancecoin.oneChance.call());
                if (callback != undefined) {
                    callback();
                }
            }
        });
}

// 部署OneChance合约
function deployOneChance(callback) {
    console.log("部署OneChance合约");
    web3.personal.unlockAccount(web3.eth.accounts[0], accountsPassword);
    var onechanceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_quantity","type":"uint32"},{"name":"_ciphertext","type":"bytes32"},{"name":"_txIndex","type":"uint256"}],"name":"buyChance","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"oneChanceCoin","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_userId","type":"uint32"},{"name":"_plaintext","type":"uint256"},{"name":"_txIndex","type":"uint256"}],"name":"submitPlaintext","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"}],"name":"goods","outputs":[{"name":"name","type":"string"},{"name":"amt","type":"uint32"},{"name":"description","type":"string"},{"name":"consumersLength","type":"uint256"},{"name":"ciphertextsLength","type":"uint32"},{"name":"plaintextsLength","type":"uint32"},{"name":"winnerId","type":"uint32"},{"name":"winnerAddr","type":"address"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"addressCompress","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_name","type":"string"},{"name":"_amt","type":"uint32"},{"name":"_description","type":"string"},{"name":"_txIndex","type":"uint256"}],"name":"postGoods","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"sponsor","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_goodsId","type":"uint32"},{"name":"_userId","type":"uint32"}],"name":"user","outputs":[{"name":"userAddr","type":"address"},{"name":"ciphertext","type":"bytes32"},{"name":"plaintext","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"topGoodsId","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"inputs":[{"name":"_oneChanceCoin","type":"address"},{"name":"_addressCompress","type":"address"}],"type":"constructor"},{"anonymous":false,"inputs":[],"name":"InitOneChanceCoin","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"PostGoods","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"consumer","type":"address"},{"indexed":false,"name":"beginUserId","type":"uint256"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"BuyChance","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"}],"name":"NotifySubmitPlaintext","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"consumer","type":"address"},{"indexed":false,"name":"txIndex","type":"uint256"}],"name":"SubmitPlaintext","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"goodsId","type":"uint256"},{"indexed":false,"name":"winner","type":"uint256"}],"name":"NotifyWinnerResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"out","type":"string"}],"name":"Print","type":"event"}]);
    onechance = onechanceContract.new(
        onechancecoin.address,
        addresscompress.address,
        {
            from: web3.eth.accounts[0], 
            data: '60606040526040516040806117df833981016040528080519060200190919080519060200190919050505b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555081600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555080600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b5050611723806100bc6000396000f360606040523615610095576000357c01000000000000000000000000000000000000000000000000000000009004806315b8003b1461009a578063356db637146100d25780635302470a14610110578063578551aa146101485780635d1388ce1461028857806369d1d1ca146102c657806377c936621461037a5780637b17e543146103b8578063d45a717e1461041a57610095565b610002565b34610002576100d06004808035906020019091908035906020019091908035906020019091908035906020019091905050610442565b005b34610002576100e460048050506108a5565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b346100025761014660048080359060200190919080359060200190919080359060200190919080359060200190919050506108cb565b005b34610002576101636004808035906020019091905050610c20565b60405180806020018963ffffffff168152602001806020018881526020018763ffffffff1681526020018663ffffffff1681526020018563ffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff16815260200183810383528b8181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156102195780820380516001836020036101000a031916815260200191505b508381038252898181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156102725780820380516001836020036101000a031916815260200191505b509a505050505050505050505060405180910390f35b346100025761029a6004805050610f40565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610002576103786004808035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019091908035906020019082018035906020019191908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050909091908035906020019091905050610f66565b005b346100025761038c6004805050611568565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610002576103dc600480803590602001909190803590602001909190505061158e565b604051808473ffffffffffffffffffffffffffffffffffffffff16815260200183600019168152602001828152602001935050505060405180910390f35b346100025761042c600480505061170e565b6040518082815260200191505060405180910390f35b60006000604060405190810160405280600081526020016000815260200150600060036000506001890363ffffffff16815481101561000257906000526020600020906006020160005b5093508360010160009054906101000a900463ffffffff1663ffffffff168763ffffffff1685600401600050805490500111156104c857610002565b600060405180827f01000000000000000000000000000000000000000000000000000000000000000281526001019150506040518091039020600019168660001916141561051557610002565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630b688f4033604051827c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff168152602001915050602060405180830381600087803b156100025760325a03f11561000257505050604051805190602001509250600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16630aa83f5a8489604051837c0100000000000000000000000000000000000000000000000000000000028152600401808363ffffffff1681526020018263ffffffff16815260200192505050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150503373ffffffffffffffffffffffffffffffffffffffff167fea878a7921291dab7a183f4734c66b4d6b59688be30cf3b3378b860ab739d4d0600186600401600050805490500187604051808381526020018281526020019250505060405180910390a28582600001906000191690818152602001505081846005016000506000866004016000508054905063ffffffff168152602001908152602001600020600050600082015181600001600050556020820151816001016000505590505083600301600481819054906101000a900463ffffffff168092919060010191906101000a81548163ffffffff0219169083021790555050600090505b8663ffffffff168163ffffffff161015610830578360040160005080548060010182818154818355818115116107e95760070160089004816007016008900483600052602060002091820191016107e891906107ca565b808211156107e457600081815060009055506001016107ca565b5090565b5b505050919090600052602060002090600891828204019190066004025b85909190916101000a81548163ffffffff02191690830217905550505b8080600101915050610773565b8360010160009054906101000a900463ffffffff1663ffffffff168460040160005080549050141561089a577f0f79d2bb89703530438ee4eedcec6dd4f56362f4a08abb7f99d5172ec2f78c1b88604051808263ffffffff16815260200191505060405180910390a15b5b5050505050505050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600060006000600060036000506001890363ffffffff16815481101561000257906000526020600020906006020160005b5093508360010160009054906101000a900463ffffffff1663ffffffff16846004016000508054905014151561093157610002565b60018703925060006001028460050160005060008563ffffffff1681526020019081526020016000206000506000016000505460001916141561097357610002565b60008460050160005060008563ffffffff168152602001908152602001600020600050600101600050541415156109a957610002565b8360050160005060008463ffffffff168152602001908152602001600020600050600001600050546000191686604051808281526020019150506040518091039020600019161415156109fb57610002565b858460050160005060008563ffffffff1681526020019081526020016000206000506001016000508190555083600301600881819054906101000a900463ffffffff168092919060010191906101000a81548163ffffffff02191690830217905550503373ffffffffffffffffffffffffffffffffffffffff167fb3e034c1f43bc4d45ac2e95fc65eefeaa5bf9cf5fb8d8e882768d02c0c76428d866040518082815260200191505060405180910390a28360030160049054906101000a900463ffffffff1663ffffffff168460030160089054906101000a900463ffffffff1663ffffffff161415610c1557600090505b8360010160009054906101000a900463ffffffff1663ffffffff168163ffffffff161015610b73578360010160009054906101000a900463ffffffff1663ffffffff168460050160005060008363ffffffff16815260200190815260200160002060005060010160005054811561000257068201915081505b8080600101915050610aed565b60018460010160009054906101000a900463ffffffff1663ffffffff168381156100025706018460030160006101000a81548163ffffffff021916908302179055507f031e7c12801a6c644cd51b871f1673da5679eb7e4b71bd0d7b64349418a714a0888560030160009054906101000a900463ffffffff16604051808363ffffffff1681526020018263ffffffff1681526020019250505060405180910390a15b5b5050505050505050565b602060405190810160405280600081526020015060006020604051908101604052806000815260200150600060006000600060006000600360005060018b0363ffffffff16815481101561000257906000526020600020906006020160005b509050806000016000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d1d5780601f10610cf257610100808354040283529160200191610d1d565b820191906000526020600020905b815481529060010190602001808311610d0057829003601f168201915b5050505050985088508060010160009054906101000a900463ffffffff1697508750806002016000508054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610dda5780601f10610daf57610100808354040283529160200191610dda565b820191906000526020600020905b815481529060010190602001808311610dbd57829003601f168201915b5050505050965086508060040160005080549050955085508060030160049054906101000a900463ffffffff16945084508060030160089054906101000a900463ffffffff16935083508060030160009054906101000a900463ffffffff169250825060008363ffffffff16141515610f3357600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16631d0cce4c826004016000506001860363ffffffff1681548110156100025790600052602060002090600891828204019190066004025b9054906101000a900463ffffffff16604051827c0100000000000000000000000000000000000000000000000000000000028152600401808263ffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150915081505b5b50919395975091939597565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60e0604051908101604052806020604051908101604052806000815260200150815260200160008152602001602060405190810160405280600081526020015081526020016000815260200160008152602001600081526020016020604051908101604052806000815260200150815260200150600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561103657610002565b84816000018190525083816020019063ffffffff1690818152602001505082816040018190525060036000508054806001018281815481835581811511611229576006028160060283600052602060002091820191016112289190611096565b8082111561122457600060008201600050805460018160011615610100020316600290046000825580601f106110cc5750611109565b601f01602090049060005260206000209081019061110891906110ea565b8082111561110457600081815060009055506001016110ea565b5090565b5b506001820160006101000a81549063ffffffff021916905560028201600050805460018160011615610100020316600290046000825580601f1061114d575061118a565b601f016020900490600052602060002090810190611189919061116b565b80821115611185576000818150600090555060010161116b565b5090565b5b506003820160006101000a81549063ffffffff02191690556003820160046101000a81549063ffffffff02191690556003820160086101000a81549063ffffffff021916905560048201600050805460008255600701600890049060005260206000209081019061121991906111fb565b8082111561121557600081815060009055506001016111fb565b5090565b5b5050600601611096565b5090565b5b5050509190906000526020600020906006020160005b8390919091506000820151816000016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061129a57805160ff19168380011785556112cb565b828001600101855582156112cb579182015b828111156112ca5782518260005055916020019190600101906112ac565b5b5090506112f691906112d8565b808211156112f257600081815060009055506001016112d8565b5090565b505060208201518160010160006101000a81548163ffffffff021916908302179055506040820151816002016000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061136e57805160ff191683800117855561139f565b8280016001018555821561139f579182015b8281111561139e578251826000505591602001919060010190611380565b5b5090506113ca91906113ac565b808211156113c657600081815060009055506001016113ac565b5090565b505060608201518160030160006101000a81548163ffffffff0219169083021790555060808201518160030160046101000a81548163ffffffff0219169083021790555060a08201518160030160086101000a81548163ffffffff0219169083021790555060c0820151816004016000509080519060200190828054828255906000526020600020906007016008900481019282156114dc5791602002820160005b838211156114aa57835183826101000a81548163ffffffff02191690830217905550926020019260040160208160030104928301926001030261146c565b80156114da5782816101000a81549063ffffffff02191690556004016020816003010492830192600103026114aa565b505b50905061151391906114e9565b8082111561150f57600081816101000a81549063ffffffff0219169055506001016114e9565b5090565b50505050507f2d3041463394d5524c09cd5c99da6cb681f797a7beb92a59ac853ab1889a04ee60036000508054905083604051808381526020018281526020019250505060405180910390a15b5b5050505050565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600060006000600060036000506001880363ffffffff16815481101561000257906000526020600020906006020160005b509150600186039050600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16631d0cce4c836004016000508363ffffffff1681548110156100025790600052602060002090600891828204019190066004025b9054906101000a900463ffffffff16604051827c0100000000000000000000000000000000000000000000000000000000028152600401808263ffffffff168152602001915050602060405180830381600087803b156100025760325a03f1156100025750505060405180519060200150945084508160050160005060008263ffffffff16815260200190815260200160002060005060000160005054935083508160050160005060008263ffffffff16815260200190815260200160002060005060010160005054925082505b50509250925092565b60006003600050805490509050611720565b9056', 
            gas: 4700000
        }, 
        function (err, contract){
            if (!err && contract.address) {
                console.log("OneChance合约部署成功");
                prompt("OneChance合约部署成功");
                $('.OneChanceAddr').text(contract.address);
                $('.OneChanceSponsorAddr').text(onechance.sponsor.call());
                $('.OneChanceAddressCompressAddr').text(onechance.addressCompress.call());
                $('.OneChanceOneChanceCoinAddr').text(onechance.oneChanceCoin.call());
                if (callback != undefined) {
                    callback();
                }
            }
        });
}

// 初始化两个合约的互相引用地址
function initContractAddr() {
    console.log("初始化合约地址");
    web3.personal.unlockAccount(web3.eth.accounts[0], accountsPassword);
    onechancecoin.initOneChance.sendTransaction(onechance.address, {from: web3.eth.accounts[0], gas: 10000000});
}
